# 緯度経度フォーマッター

緯度経度データの形式を簡単に変換できるWebアプリケーションです。

**1列形式** (`座標` 列に `35.6762,139.6503`) と **2列形式** (`緯度` 列と `経度` 列に分かれている) の相互変換に対応しています。

## 機能

- 📁 **CSVファイルアップロード**: ドラッグ&ドロップで簡単アップロード
- 🔄 **形式の相互変換**:
  - 1列形式 → 2列形式
  - 2列形式 → 1列形式
- 📊 **自動検出**: 緯度・経度列を自動検出
- 🔍 **データプレビュー**: アップロード直後と変換後にプレビュー
- 📐 **桁数調整**: 緯度経度の小数点以下の桁数を調整可能（減らすのみ）
- 📥 **ダウンロード**: 変換済みCSVをダウンロード
- ⚡ **ブラウザ内処理**: API不要、オフライン対応

## セットアップ

### 必要な環境

- Node.js (v14以上)
- npm

### インストール

```bash
# パッケージをインストール
npm install
```

### サーバー起動

```bash
npm start
```

ブラウザで `http://localhost:3000` にアクセス

## 使い方

### 基本的な流れ

1. **CSVファイルをアップロード**
   - ファイルをドラッグ&ドロップまたは「選択」をクリック
   - CSV形式に対応

2. **データプレビューを確認**
   - アップロード直後に最初の5行が表示されます
   - 列名と内容を確認

3. **座標データの形式を選択**
   - **現在の形式**: 元のCSVの形式を選択
     - 1列形式: `座標` のように1つの列に `"35.6762,139.6503"` 形式
     - 2列形式: `緯度` 列と `経度` 列に分かれている
   - **変換後の形式**: 出力形式を選択
   - **緯度・経度の列**: 選択した形式に応じて列を指定

4. **小数点以下の桁数を調整（オプション）**
   - 元データより少ない桁数に減らすことができます
   - デフォルトは元データの桁数のまま
   - 例: 4桁 → 2桁に減らすと `35.6762` → `35.68`

5. **「形式を変換」をクリック**
   - データが変換されます
   - 画面下部に変換後のデータプレビューが表示されます

6. **プレビューを確認してから「ダウンロード」**
   - 変換後のデータが正しいか確認
   - 「ダウンロード」をクリックして CSV をダウンロード
   - ファイル名に `_1col` または `_2col` のサフィックスが付きます

## 対応ファイル形式

### 入力: CSV

```csv
name,座標,description
Location A,35.6762139.6503,東京
Location B,34.6937,135.5023,京都
```

または

```csv
name,緯度,経度,description
Location A,35.6762,139.6503,東京
Location B,34.6937,135.5023,京都
```

### 出力

**1列形式**
```csv
name,座標,description
Location A,"35.6762,139.6503",東京
Location B,"34.6937,135.5023",京都
```

**2列形式**
```csv
name,緯度,経度,description
Location A,35.68,139.65,東京
Location B,34.69,135.50,京都
```

## 桁数調整について

- **元データより多い桁数には設定できません**（情報がないため）
- 桁数を減らすと自動的に四捨五入されます
- 例: 4桁のデータから 2桁を選択 → 四捨五入される

## セキュリティ

- **ブラウザ内処理**: 全ての変換処理はブラウザ内で実行
- **外部API不要**: インターネット接続なしで動作可能
- **データプライバシー**: CSVデータはサーバーに送信されません

## 技術スタック

- **フロントエンド**: HTML, CSS, JavaScript (Vanilla)
- **CSV処理**: Papa Parse
- **バックエンド**: Node.js + Express（静的ファイル提供のみ）
- **認証**: Supabase + dataviz-auth-client.js

## 認証クライアント (dataviz-auth-client.js)

このツールは dataviz.jp の共通認証システムを使用しています。

### 主な機能

- **自動ログイン状態管理**: Supabase認証を使用した自動セッション管理
- **共通ヘッダー**: Web Component (`<dataviz-header>`) による統一されたUI
- **サブスクリプション確認**: アクティブなサブスクリプションの自動検証
- **クッキーベースの認証**: `.dataviz.jp` ドメイン全体で共有される認証状態

### リファクタリング内容 (2025-12-31)

最新版の `dataviz-auth-client.js` では以下の改善が行われました:

1. **グローバル変数名の変更**
   - `window.supabase` → `window.datavizSupabase`
   - より明示的な命名で他のSupabaseインスタンスとの競合を回避

2. **Web Component標準化**
   - Custom Elements API (`DatavizGlobalHeader extends HTMLElement`) を使用
   - より標準的で保守性の高い実装

3. **認証フローの簡素化**
   - フォールバックチェックを削除
   - `onAuthStateChange` イベントのみで処理

4. **デバッグモード対応**
   - URLに `?auth_debug` を追加することでリダイレクトを抑制
   - ローカル開発時に便利: `http://localhost:3000/?auth_debug`

### デバッグモードの使用方法

ローカルサーバーで動作確認する際、認証リダイレクトを避けるには:

```
http://localhost:3000/?auth_debug
```

このパラメータを付けると、ログイン画面へのリダイレクトが抑制され、コンソールに警告メッセージが表示されます。

## ファイル構成

```
.
├── server.js                        # Node.js サーバー
├── index.html                       # UIマークアップ
├── style.css                        # スタイル
├── script.js                        # メインロジック（CSV解析・変換）
├── js/
│   └── lib/
│       ├── supabase.js              # Supabase クライアントライブラリ
│       ├── dataviz-auth-client.js   # 認証クライアント（リファクタリング済み）
│       └── dataviz-auth-client_old.js # 旧認証クライアント（参考用）
├── package.json                     # 依存パッケージ
├── sample.csv                       # サンプルデータ
├── .gitignore                       # Git除外ファイル
└── README.md                        # このファイル
```

## トラブルシューティング

### npm: command not found

Node.jsがインストールされていません。[Node.js公式](https://nodejs.org)からインストール

### ファイルが読み込まれない

- ファイル形式が CSV か確認
- ヘッダー行（最初の行）が正しく設定されているか確認
- 空行が多すぎないか確認

### 列が自動検出されない

- 列名が「lat」「latitude」「緯度」などの一般的な名前であるか確認
- 列名に半角スペースが含まれていないか確認

### ポート3000がすでに使われている

別のポート番号を指定：
```bash
PORT=3001 npm start
```

## 開発

```bash
# サーバー起動
npm start

# ブラウザで http://localhost:3000 にアクセス
```

## ライセンス

MIT License

## 参考リンク

- [Papa Parse](https://www.papaparse.com/) - CSV パーサー
- [RFC 4180 - CSV 形式](https://tools.ietf.org/html/rfc4180)
